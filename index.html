<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Italian Conjugation Practice</title>
    <link
      rel="manifest"
      href="data:application/json;base64,eyJuYW1lIjoiSXRhbGlhbiBDb25qdWdhdGlvbiBQcmFjdGljZSIsInNob3J0X25hbWUiOiJJdGFsaWFuQ29uaiIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMmU3ZDMyIiwidGhlbWVfY29sb3IiOiIjMmU3ZDMyIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIZHBaSFJvUFNJeE1qQWlJR2hsYVdkb2REMG9NVEF3SWo0OFkybHlZMnhsSUdONFBTSTJNQ0lnWTNrOUlqWXdJaUJ5UFNJek1DSWdabWxzYkQwaUl6SXpOekU0TXlJdlBqeDBaWGgwSUhnMlBTSTJNQ0lnZVRJOUlqUWlJSE4wZVd4bFBTSm1hV3hzT2lOdmJIZDBaVnRtYjI1MExYTnBlbVU2TVRBd2VIQmNJaUowWlhoMExXRnVZMmh2Y2owaWJXbGtaR3hsSWo1RFQwNGNUa1JjVkR3dmRHVjRkRDQ4TDNOMlp6ND0iLCJzaXplcyI6IjEyMHgxMjAiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0="
    />
    <script src="https://code.responsivevoice.org/responsivevoice.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 1.1em;
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
      }

      .tab {
        background: none;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        font-size: 1em;
        color: #6c757d;
        transition: all 0.3s ease;
      }

      .tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
        font-weight: 600;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .practice-section {
        text-align: center;
        margin-bottom: 30px;
      }

      .level-selectors {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .level-group {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #dee2e6;
      }

      .level-group label {
        font-weight: 600;
        color: #495057;
        display: block;
        margin-bottom: 8px;
      }

      .level-group select {
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        font-size: 1em;
        background: white;
      }

      .conjugation-display {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 30px;
        margin: 25px 0;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        border: 2px solid #dee2e6;
      }

      .verb-prompt {
        font-size: 1.8em;
        font-weight: 600;
        color: #495057;
        margin-bottom: 15px;
      }

      .conjugation-prompt {
        font-size: 1.3em;
        color: #6c757d;
        margin-bottom: 20px;
      }

      .answer-section {
        margin-top: 20px;
      }

      .answer-input {
        padding: 15px;
        font-size: 1.2em;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        width: 100%;
        max-width: 300px;
        text-align: center;
        transition: border-color 0.3s ease;
      }

      .answer-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .answer-input.correct {
        border-color: #28a745;
        background-color: #d4edda;
      }

      .answer-input.incorrect {
        border-color: #dc3545;
        background-color: #f8d7da;
      }

      .controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 20px;
      }

      .btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-secondary:hover {
        box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
      }

      .btn-success {
        background: #28a745;
      }

      .btn-success:hover {
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
      }

      .btn-warning {
        background: #ffc107;
        color: #212529;
      }

      .btn-warning:hover {
        box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
      }

      .feedback-section {
        margin-top: 20px;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        display: none;
      }

      .feedback-section.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        display: block;
      }

      .feedback-section.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        display: block;
      }

      .feedback-section.info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
        display: block;
      }

      .empty-state {
        color: #6c757d;
        font-style: italic;
        font-size: 1.1em;
      }

      .stats-section {
        display: flex;
        justify-content: space-around;
        margin: 20px 0;
        text-align: center;
      }

      .stat-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #dee2e6;
      }

      .stat-number {
        font-size: 1.5em;
        font-weight: 600;
        color: #495057;
      }

      .stat-label {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 5px;
      }

      .speaker-icon, .dict-icon {
        cursor: pointer;
        margin: 0 8px;
        font-size: 1.2em;
        opacity: 0.8;
        transition: all 0.2s;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
        padding: 4px 6px;
      }

      .speaker-icon:hover, .dict-icon:hover {
        transform: scale(1.2);
        opacity: 1;
        background: rgba(255, 255, 255, 0.3);
      }

      .info-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        line-height: 1.6;
      }

      .info-section h3 {
        color: #495057;
        margin-bottom: 20px;
        text-align: center;
      }

      .info-section h4 {
        color: #495057;
        margin-top: 20px;
        margin-bottom: 10px;
      }

      .info-section ul {
        margin-left: 20px;
        margin-bottom: 15px;
      }

      .info-section li {
        margin-bottom: 5px;
      }

      @media (max-width: 600px) {
        .container {
          padding: 15px;
        }

        .header h1 {
          font-size: 2em;
        }

        .level-selectors {
          flex-direction: column;
          align-items: center;
        }

        .controls {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }

        .stats-section {
          flex-direction: column;
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üáÆüáπ Coniugazioni</h1>
        <p>Practice Italian verb conjugations</p>
      </div>

      <div class="card">
        <div class="tabs">
          <button class="tab active" data-tab="practice">Practice</button>
          <button class="tab" data-tab="settings">Settings</button>
          <button class="tab" data-tab="progress">Progress</button>
          <button class="tab" data-tab="info">Info</button>
        </div>

        <div class="tab-content active" id="practice">
          <div class="practice-section">
            <div class="stats-section">
              <div class="stat-item">
                <div class="stat-number" id="correctCount">0</div>
                <div class="stat-label">Correct</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Total</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="accuracyPercent">0%</div>
                <div class="stat-label">Accuracy</div>
              </div>
            </div>

            <div class="conjugation-display" id="conjugationDisplay">
              <div class="empty-state">
                Click "New Verb" to start practicing!
              </div>
            </div>

            <div class="controls">
              <button class="btn" onclick="getNewVerb()">New Verb</button>
              <button class="btn btn-secondary" onclick="resetStats()">Reset Stats</button>
            </div>
          </div>
        </div>

        <div class="tab-content" id="settings">
          <div class="level-selectors">
            <div class="level-group">
              <label>Verb Difficulty:</label>
              <select id="verbLevel" onchange="updateSettings()">
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced" selected>Advanced</option>
              </select>
            </div>
            <div class="level-group">
              <label>Conjugation Types:</label>
              <select id="conjugationLevel" onchange="updateSettings()">
                <option value="basic" selected>Basic</option>
                <option value="advanced">Advanced</option>
              </select>
            </div>
          </div>

          <div style="margin-top: 30px;">
            <h4 style="text-align: center; margin-bottom: 15px;">Practice Options</h4>
            
            <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="showRegularityHint" checked>
                Show regularity hints
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="allowMultipleAttempts" checked>
                Allow multiple attempts
              </label>
            </div>
          </div>

          <div style="margin-top: 30px; text-align: center;">
            <h4 style="margin-bottom: 15px;">Available Verbs</h4>
            <p style="color: #6c757d; font-size: 0.9em;">
              Currently practicing with <span id="verbCountDisplay">20</span> verbs
            </p>
          </div>
        </div>

        <div class="tab-content" id="progress">
          <div style="text-align: center;">
            <h3 style="margin-bottom: 20px;">Practice Progress</h3>
            
            <div class="stats-section">
              <div class="stat-item">
                <div class="stat-number" id="sessionLength">0</div>
                <div class="stat-label">This Session</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="currentStreak">0</div>
                <div class="stat-label">Current Streak</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="bestStreak">0</div>
                <div class="stat-label">Best Streak</div>
              </div>
            </div>

            <div style="margin-top: 30px;">
              <h4 style="margin-bottom: 15px;">Recent Mistakes</h4>
              <div id="recentMistakes" style="text-align: left; max-height: 200px; overflow-y: auto;">
                <p style="color: #6c757d; font-style: italic; text-align: center;">No mistakes yet - great job!</p>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" id="info">
          <div class="info-section">
            <h3>Italian Conjugation Practice - Instructions</h3>

            <h4>How to Use:</h4>
            <p>
              <strong>Practice Tab:</strong> Click "New Verb" to get a random verb and conjugation challenge. Type your answer and press Enter to submit. If wrong, you can try again or reveal the correct answer.
            </p>

            <p>
              <strong>Settings Tab:</strong> Choose your verb difficulty level and conjugation complexity. Beginner verbs include the most common ones, while Advanced includes more irregular and complex verbs.
            </p>

            <h4>Features:</h4>
            <ul>
              <li>üîä Click the speaker icon to hear pronunciation of the verb</li>
              <li>üìñ Click the book icon to view full conjugation tables</li>
              <li>üí° Regularity hints show if a verb follows regular patterns</li>
              <li>üìä Track your accuracy and progress over time</li>
              <li>üéØ Focus on specific tenses and difficulty levels</li>
            </ul>

            <h4>Conjugation Types:</h4>
            <p>
              <strong>Basic:</strong> Present tense, Past tense (Passato Prossimo), Future tense, and Imperative mood.
            </p>
            <p>
              <strong>Advanced:</strong> Includes Subjunctive, Conditional, Imperfect, and other complex tenses.
            </p>

            <h4>Tips:</h4>
            <ul>
              <li>Start with Basic conjugations and Beginner verbs to build confidence</li>
              <li>Pay attention to the grammatical terminology - it helps reinforce learning</li>
              <li>Use the pronunciation feature to improve your spoken Italian</li>
              <li>Regular practice is more effective than long study sessions</li>
            </ul>

            <p style="margin-top: 20px; font-style: italic; color: #6c757d">
              Buona pratica! (Good practice!)
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Verb conjugation database - 20 most common Italian verbs
      const verbDatabase = {
        "essere": {
          translation: "to be",
          regular: false,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "sono", tu: "sei", lui: "√®", noi: "siamo", voi: "siete", loro: "sono"
            },
            passato_prossimo: {
              io: "sono stato/a", tu: "sei stato/a", lui: "√® stato/a", 
              noi: "siamo stati/e", voi: "siete stati/e", loro: "sono stati/e"
            },
            futuro: {
              io: "dovr√≤", tu: "dovrai", lui: "dovr√†", noi: "dovremo", voi: "dovrete", loro: "dovranno"
            },
            condizionale: {
              io: "dovrei", tu: "dovresti", lui: "dovrebbe", noi: "dovremmo", voi: "dovreste", loro: "dovrebbero"
            }
          }
        },
        "venire": {
          translation: "to come",
          regular: false,
          difficulty: "intermediate",
          conjugations: {
            presente: {
              io: "vengo", tu: "vieni", lui: "viene", noi: "veniamo", voi: "venite", loro: "vengono"
            },
            passato_prossimo: {
              io: "sono venuto/a", tu: "sei venuto/a", lui: "√® venuto/a", 
              noi: "siamo venuti/e", voi: "siete venuti/e", loro: "sono venuti/e"
            },
            futuro: {
              io: "verr√≤", tu: "verrai", lui: "verr√†", noi: "verremo", voi: "verrete", loro: "verranno"
            },
            imperativo: {
              tu: "vieni", lui: "venga", noi: "veniamo", voi: "venite", loro: "vengano"
            }
          }
        },
        "uscire": {
          translation: "to go out",
          regular: false,
          difficulty: "intermediate",
          conjugations: {
            presente: {
              io: "esco", tu: "esci", lui: "esce", noi: "usciamo", voi: "uscite", loro: "escono"
            },
            passato_prossimo: {
              io: "sono uscito/a", tu: "sei uscito/a", lui: "√® uscito/a", 
              noi: "siamo usciti/e", voi: "siete usciti/e", loro: "sono usciti/e"
            },
            futuro: {
              io: "uscir√≤", tu: "uscirai", lui: "uscir√†", noi: "usciremo", voi: "uscirete", loro: "usciranno"
            },
            imperativo: {
              tu: "esci", lui: "esca", noi: "usciamo", voi: "uscite", loro: "escano"
            }
          }
        },
        "parlare": {
          translation: "to speak",
          regular: true,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "parlo", tu: "parli", lui: "parla", noi: "parliamo", voi: "parlate", loro: "parlano"
            },
            passato_prossimo: {
              io: "ho parlato", tu: "hai parlato", lui: "ha parlato", 
              noi: "abbiamo parlato", voi: "avete parlato", loro: "hanno parlato"
            },
            futuro: {
              io: "parler√≤", tu: "parlerai", lui: "parler√†", noi: "parleremo", voi: "parlerete", loro: "parleranno"
            },
            imperativo: {
              tu: "parla", lui: "parli", noi: "parliamo", voi: "parlate", loro: "parlino"
            },
            congiuntivo_presente: {
              io: "parli", tu: "parli", lui: "parli", noi: "parliamo", voi: "parliate", loro: "parlino"
            },
            condizionale: {
              io: "parlerei", tu: "parleresti", lui: "parlerebbe", noi: "parleremmo", voi: "parlereste", loro: "parlerebbero"
            }
          }
        },
        "mangiare": {
          translation: "to eat",
          regular: true,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "mangio", tu: "mangi", lui: "mangia", noi: "mangiamo", voi: "mangiate", loro: "mangiano"
            },
            passato_prossimo: {
              io: "ho mangiato", tu: "hai mangiato", lui: "ha mangiato", 
              noi: "abbiamo mangiato", voi: "avete mangiato", loro: "hanno mangiato"
            },
            futuro: {
              io: "manger√≤", tu: "mangerai", lui: "manger√†", noi: "mangeremo", voi: "mangerete", loro: "mangeranno"
            },
            imperativo: {
              tu: "mangia", lui: "mangi", noi: "mangiamo", voi: "mangiate", loro: "mangino"
            }
          }
        },
        "dormire": {
          translation: "to sleep",
          regular: true,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "dormo", tu: "dormi", lui: "dorme", noi: "dormiamo", voi: "dormite", loro: "dormono"
            },
            passato_prossimo: {
              io: "ho dormito", tu: "hai dormito", lui: "ha dormito", 
              noi: "abbiamo dormito", voi: "avete dormito", loro: "hanno dormito"
            },
            futuro: {
              io: "dormir√≤", tu: "dormirai", lui: "dormir√†", noi: "dormiremo", voi: "dormirete", loro: "dormiranno"
            },
            imperativo: {
              tu: "dormi", lui: "dorma", noi: "dormiamo", voi: "dormite", loro: "dormano"
            }
          }
        },
        "lavorare": {
          translation: "to work",
          regular: true,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "lavoro", tu: "lavori", lui: "lavora", noi: "lavoriamo", voi: "lavorate", loro: "lavorano"
            },
            passato_prossimo: {
              io: "ho lavorato", tu: "hai lavorato", lui: "ha lavorato", 
              noi: "abbiamo lavorato", voi: "avete lavorato", loro: "hanno lavorato"
            },
            futuro: {
              io: "lavorer√≤", tu: "lavorerai", lui: "lavorer√†", noi: "lavoreremo", voi: "lavorerete", loro: "lavoreranno"
            },
            imperativo: {
              tu: "lavora", lui: "lavori", noi: "lavoriamo", voi: "lavorate", loro: "lavorino"
            }
          }
        },
        "studiare": {
          translation: "to study",
          regular: true,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "studio", tu: "studi", lui: "studia", noi: "studiamo", voi: "studiate", loro: "studiano"
            },
            passato_prossimo: {
              io: "ho studiato", tu: "hai studiato", lui: "ha studiato", 
              noi: "abbiamo studiato", voi: "avete studiato", loro: "hanno studiato"
            },
            futuro: {
              io: "studier√≤", tu: "studierai", lui: "studier√†", noi: "studieremo", voi: "studierete", loro: "studieranno"
            },
            imperativo: {
              tu: "studia", lui: "studi", noi: "studiamo", voi: "studiate", loro: "studino"
            }
          }
        },
        "abitare": {
          translation: "to live",
          regular: true,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "abito", tu: "abiti", lui: "abita", noi: "abitiamo", voi: "abitate", loro: "abitano"
            },
            passato_prossimo: {
              io: "ho abitato", tu: "hai abitato", lui: "ha abitato", 
              noi: "abbiamo abitato", voi: "avete abitato", loro: "hanno abitato"
            },
            futuro: {
              io: "abiter√≤", tu: "abiterai", lui: "abiter√†", noi: "abiteremo", voi: "abiterete", loro: "abiteranno"
            },
            imperativo: {
              tu: "abita", lui: "abiti", noi: "abitiamo", voi: "abitate", loro: "abitino"
            }
          }
        },
        "sentire": {
          translation: "to feel/hear",
          regular: true,
          difficulty: "intermediate",
          conjugations: {
            presente: {
              io: "sento", tu: "senti", lui: "sente", noi: "sentiamo", voi: "sentite", loro: "sentono"
            },
            passato_prossimo: {
              io: "ho sentito", tu: "hai sentito", lui: "ha sentito", 
              noi: "abbiamo sentito", voi: "avete sentito", loro: "hanno sentito"
            },
            futuro: {
              io: "sentir√≤", tu: "sentirai", lui: "sentir√†", noi: "sentiremo", voi: "sentirete", loro: "sentiranno"
            },
            imperativo: {
              tu: "senti", lui: "senta", noi: "sentiamo", voi: "sentite", loro: "sentano"
            }
          }
        }
      };

      // Conjugation type definitions
      const conjugationTypes = {
        basic: ['presente', 'passato_prossimo', 'futuro', 'imperativo'],
        advanced: ['presente', 'passato_prossimo', 'futuro', 'imperativo', 'congiuntivo_presente', 'condizionale']
      };

      // Person definitions in Italian
      const persons = {
        io: "prima persona singolare",
        tu: "seconda persona singolare", 
        lui: "terza persona singolare",
        noi: "prima persona plurale",
        voi: "seconda persona plurale",
        loro: "terza persona plurale"
      };

      // Tense names in Italian
      const tenseNames = {
        presente: "presente",
        passato_prossimo: "passato prossimo",
        futuro: "futuro",
        imperativo: "imperativo",
        congiuntivo_presente: "congiuntivo presente",
        condizionale: "condizionale"
      };

      // Current practice state
      let currentVerb = null;
      let currentTense = null;
      let currentPerson = null;
      let currentAnswer = null;
      let attempts = 0;
      let maxAttempts = 3;

      // Statistics
      let stats = {
        correct: 0,
        total: 0,
        currentStreak: 0,
        bestStreak: 0,
        recentMistakes: []
      };

      // Settings
      let settings = {
        verbLevel: 'advanced',
        conjugationLevel: 'basic',
        showRegularityHint: true,
        allowMultipleAttempts: true
      };

      // Function to pronounce Italian words using ResponsiveVoice
      function pronounceWord(word) {
        if (typeof responsiveVoice !== "undefined") {
          responsiveVoice.speak(word, "Italian Male", {
            rate: 0.95,
            pitch: 1,
            volume: 1,
          });
        } else {
          console.log("ResponsiveVoice not loaded yet");
          alert("Pronunciation feature is still loading. Please try again in a moment.");
        }
      }

      // Open Italian conjugation in new tab
      function openConjugation(verb) {
        const conjugationUrl = `https://conjugator.reverso.net/conjugation-italian-verb-${encodeURIComponent(verb)}.html`;
        window.open(conjugationUrl, "_blank");
      }

      // Normalize text for comparison (remove accents, case insensitive)
      function normalizeText(text) {
        return text
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "") // Remove accent marks
          .replace(/['']/g, "'") // Normalize apostrophes
          .trim();
      }

      // Get available verbs based on current difficulty setting
      function getAvailableVerbs() {
        const targetDifficulties = [];
        
        if (settings.verbLevel === 'beginner') {
          targetDifficulties.push('beginner');
        } else if (settings.verbLevel === 'intermediate') {
          targetDifficulties.push('beginner', 'intermediate');
        } else {
          targetDifficulties.push('beginner', 'intermediate', 'advanced');
        }

        return Object.keys(verbDatabase).filter(verb => 
          targetDifficulties.includes(verbDatabase[verb].difficulty)
        );
      }

      // Get available tenses based on conjugation level setting
      function getAvailableTenses(verb) {
        const verbData = verbDatabase[verb];
        const availableForLevel = conjugationTypes[settings.conjugationLevel];
        
        return availableForLevel.filter(tense => 
          verbData.conjugations[tense] !== undefined
        );
      }

      // Get new random verb conjugation challenge
      function getNewVerb() {
        const availableVerbs = getAvailableVerbs();
        
        if (availableVerbs.length === 0) {
          showFeedback('No verbs available for current settings', 'error');
          return;
        }

        // Select random verb
        currentVerb = availableVerbs[Math.floor(Math.random() * availableVerbs.length)];
        
        // Get available tenses for this verb
        const availableTenses = getAvailableTenses(currentVerb);
        
        if (availableTenses.length === 0) {
          showFeedback('No tenses available for this verb', 'error');
          return;
        }

        // Select random tense
        currentTense = availableTenses[Math.floor(Math.random() * availableTenses.length)];
        
        // Select random person
        const availablePersons = Object.keys(verbDatabase[currentVerb].conjugations[currentTense]);
        currentPerson = availablePersons[Math.floor(Math.random() * availablePersons.length)];
        
        // Get correct answer
        currentAnswer = verbDatabase[currentVerb].conjugations[currentTense][currentPerson];
        
        // Reset attempts
        attempts = 0;
        
        // Display the challenge
        displayChallenge();
        
        // Clear previous feedback
        hideFeedback();
        
        console.log(`New challenge: ${currentVerb} - ${currentTense} - ${currentPerson} = ${currentAnswer}`);
      }

      // Display the current challenge
      function displayChallenge() {
        const display = document.getElementById('conjugationDisplay');
        const verbData = verbDatabase[currentVerb];
        
        const regularityHint = settings.showRegularityHint ? 
          `<div style="font-size: 0.9em; color: #6c757d; margin-bottom: 15px;">
            ${verbData.regular ? '‚úì Regular verb' : '‚ö†Ô∏è Irregular verb'}
          </div>` : '';

        display.innerHTML = `
          <div class="verb-prompt">
            ${currentVerb}
            <span class="speaker-icon" onclick="pronounceWord('${currentVerb}')" title="Pronounce verb">üîä</span>
            <span class="dict-icon" onclick="openConjugation('${currentVerb}')" title="View full conjugation">üìñ</span>
          </div>
          <div style="font-size: 1.1em; color: #6c757d; margin-bottom: 15px;">
            ${verbData.translation}
          </div>
          ${regularityHint}
          <div class="conjugation-prompt">
            ${tenseNames[currentTense]} - ${persons[currentPerson]}
          </div>
          <div class="answer-section">
            <input type="text" class="answer-input" id="answerInput" 
                   placeholder="Type your answer..." onkeypress="handleKeyPress(event)">
          </div>
          <div class="controls" style="margin-top: 15px;">
            <button class="btn" onclick="checkAnswer()">Check Answer</button>
            <button class="btn btn-warning" onclick="showCorrectAnswer()">Show Answer</button>
          </div>
        `;
        
        // Focus on input
        document.getElementById('answerInput').focus();
      }

      // Handle Enter key press
      function handleKeyPress(event) {
        if (event.key === 'Enter') {
          checkAnswer();
        }
      }

      // Check the user's answer
      function checkAnswer() {
        const userAnswer = document.getElementById('answerInput').value.trim();
        
        if (!userAnswer) {
          showFeedback('Please enter an answer', 'error');
          return;
        }

        attempts++;
        
        // Normalize both answers for comparison
        const normalizedUser = normalizeText(userAnswer);
        const normalizedCorrect = normalizeText(currentAnswer);
        
        if (normalizedUser === normalizedCorrect) {
          // Correct answer
          handleCorrectAnswer();
        } else {
          // Wrong answer
          handleWrongAnswer(userAnswer);
        }
      }

      // Handle correct answer
      function handleCorrectAnswer() {
        const input = document.getElementById('answerInput');
        input.className = 'answer-input correct';
        input.disabled = true;
        
        // Update stats
        stats.correct++;
        stats.total++;
        stats.currentStreak++;
        
        if (stats.currentStreak > stats.bestStreak) {
          stats.bestStreak = stats.currentStreak;
        }
        
        updateStatsDisplay();
        
        showFeedback(`Correct! üéâ`, 'success');
        
        // Auto-advance after 2 seconds
        setTimeout(() => {
          getNewVerb();
        }, 2000);
      }

      // Handle wrong answer
      function handleWrongAnswer(userAnswer) {
        const input = document.getElementById('answerInput');
        input.className = 'answer-input incorrect';
        
        stats.total++;
        stats.currentStreak = 0;
        
        // Add to recent mistakes
        stats.recentMistakes.unshift({
          verb: currentVerb,
          tense: currentTense,
          person: currentPerson,
          userAnswer: userAnswer,
          correctAnswer: currentAnswer,
          timestamp: new Date()
        });
        
        // Keep only last 10 mistakes
        if (stats.recentMistakes.length > 10) {
          stats.recentMistakes = stats.recentMistakes.slice(0, 10);
        }
        
        updateStatsDisplay();
        updateRecentMistakes();
        
        if (settings.allowMultipleAttempts && attempts < maxAttempts) {
          showFeedback(`Not quite right. Try again! (Attempt ${attempts}/${maxAttempts})`, 'error');
          
          // Reset input style after a moment and let them try again
          setTimeout(() => {
            input.className = 'answer-input';
            input.value = '';
            input.focus();
          }, 1500);
        } else {
          showFeedback(`Incorrect. The answer is: <strong>${currentAnswer}</strong>`, 'error');
          input.disabled = true;
          
          // Auto-advance after 3 seconds
          setTimeout(() => {
            getNewVerb();
          }, 3000);
        }
      }

      // Show correct answer
      function showCorrectAnswer() {
        const input = document.getElementById('answerInput');
        input.value = currentAnswer;
        input.className = 'answer-input';
        input.disabled = true;
        
        showFeedback(`The correct answer is: <strong>${currentAnswer}</strong>`, 'info');
        
        // This counts as getting it wrong for stats
        stats.total++;
        stats.currentStreak = 0;
        updateStatsDisplay();
        
        // Auto-advance after 3 seconds
        setTimeout(() => {
          getNewVerb();
        }, 3000);
      }

      // Show feedback message
      function showFeedback(message, type) {
        const feedback = document.querySelector('.feedback-section');
        if (!feedback) {
          // Create feedback section if it doesn't exist
          const feedbackDiv = document.createElement('div');
          feedbackDiv.className = 'feedback-section';
          document.getElementById('conjugationDisplay').appendChild(feedbackDiv);
        }
        
        const feedbackElement = document.querySelector('.feedback-section');
        feedbackElement.innerHTML = message;
        feedbackElement.className = `feedback-section ${type}`;
      }

      // Hide feedback
      function hideFeedback() {
        const feedback = document.querySelector('.feedback-section');
        if (feedback) {
          feedback.className = 'feedback-section';
        }
      }

      // Update statistics display
      function updateStatsDisplay() {
        document.getElementById('correctCount').textContent = stats.correct;
        document.getElementById('totalCount').textContent = stats.total;
        
        const accuracy = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
        document.getElementById('accuracyPercent').textContent = accuracy + '%';
        
        document.getElementById('sessionLength').textContent = stats.total;
        document.getElementById('currentStreak').textContent = stats.currentStreak;
        document.getElementById('bestStreak').textContent = stats.bestStreak;
      }

      // Update recent mistakes display
      function updateRecentMistakes() {
        const container = document.getElementById('recentMistakes');
        
        if (stats.recentMistakes.length === 0) {
          container.innerHTML = '<p style="color: #6c757d; font-style: italic; text-align: center;">No mistakes yet - great job!</p>';
          return;
        }
        
        const mistakesHtml = stats.recentMistakes.map(mistake => `
          <div style="background: #f8f9fa; padding: 10px; margin-bottom: 8px; border-radius: 5px; border-left: 3px solid #dc3545;">
            <strong>${mistake.verb}</strong> (${tenseNames[mistake.tense]} - ${persons[mistake.person]})<br>
            <span style="color: #dc3545;">Your answer: ${mistake.userAnswer}</span><br>
            <span style="color: #28a745;">Correct: ${mistake.correctAnswer}</span>
          </div>
        `).join('');
        
        container.innerHTML = mistakesHtml;
      }

      // Reset statistics
      function resetStats() {
        stats = {
          correct: 0,
          total: 0,
          currentStreak: 0,
          bestStreak: 0,
          recentMistakes: []
        };
        
        updateStatsDisplay();
        updateRecentMistakes();
        
        showFeedback('Statistics reset!', 'info');
        setTimeout(hideFeedback, 2000);
      }

      // Update settings
      function updateSettings() {
        settings.verbLevel = document.getElementById('verbLevel').value;
        settings.conjugationLevel = document.getElementById('conjugationLevel').value;
        settings.showRegularityHint = document.getElementById('showRegularityHint').checked;
        settings.allowMultipleAttempts = document.getElementById('allowMultipleAttempts').checked;
        
        // Update verb count display
        const availableVerbs = getAvailableVerbs();
        document.getElementById('verbCountDisplay').textContent = availableVerbs.length;
        
        console.log('Settings updated:', settings);
      }

      // Tab switching functionality
      function setupTabSwitching() {
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
          });
        });
      }

      // Initialize the app
      function initializeApp() {
        setupTabSwitching();
        updateSettings();
        updateStatsDisplay();
        updateRecentMistakes();
        
        console.log('Italian Conjugation Practice app initialized');
        console.log('Available verbs:', Object.keys(verbDatabase).length);
      }

      // Wait for DOM to be ready before initializing
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
      } else {
        initializeApp();
      }

      // Register service worker for PWA functionality
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4gewogIGV2ZW50LndhaXRVbnRpbChzZWxmLnNraXBXYWl0aW5nKCkpOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignYWN0aXZhdGUnLCBldmVudCA9PiB7CiAgZXZlbnQud2FpdFVudGlsKHNlbGYuY2xpZW50cy5jbGFpbSgpKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZXZlbnQgPT4gewogIGV2ZW50LnJlc3BvbmRXaXRoKGZldGNoKGV2ZW50LnJlcXVlc3QpKTsKfSk7')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed'));
      }
    </script>
  </body>
</html>
              io: "sar√≤", tu: "sarai", lui: "sar√†", noi: "saremo", voi: "sarete", loro: "saranno"
            },
            imperativo: {
              tu: "sii", lui: "sia", noi: "siamo", voi: "siate", loro: "siano"
            },
            congiuntivo_presente: {
              io: "sia", tu: "sia", lui: "sia", noi: "siamo", voi: "siate", loro: "siano"
            },
            condizionale: {
              io: "sarei", tu: "saresti", lui: "sarebbe", noi: "saremmo", voi: "sareste", loro: "sarebbero"
            }
          }
        },
        "avere": {
          translation: "to have",
          regular: false,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "ho", tu: "hai", lui: "ha", noi: "abbiamo", voi: "avete", loro: "hanno"
            },
            passato_prossimo: {
              io: "ho avuto", tu: "hai avuto", lui: "ha avuto", 
              noi: "abbiamo avuto", voi: "avete avuto", loro: "hanno avuto"
            },
            futuro: {
              io: "avr√≤", tu: "avrai", lui: "avr√†", noi: "avremo", voi: "avrete", loro: "avranno"
            },
            imperativo: {
              tu: "abbi", lui: "abbia", noi: "abbiamo", voi: "abbiate", loro: "abbiano"
            },
            congiuntivo_presente: {
              io: "abbia", tu: "abbia", lui: "abbia", noi: "abbiamo", voi: "abbiate", loro: "abbiano"
            },
            condizionale: {
              io: "avrei", tu: "avresti", lui: "avrebbe", noi: "avremmo", voi: "avreste", loro: "avrebbero"
            }
          }
        },
        "fare": {
          translation: "to do/make",
          regular: false,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "faccio", tu: "fai", lui: "fa", noi: "facciamo", voi: "fate", loro: "fanno"
            },
            passato_prossimo: {
              io: "ho fatto", tu: "hai fatto", lui: "ha fatto", 
              noi: "abbiamo fatto", voi: "avete fatto", loro: "hanno fatto"
            },
            futuro: {
              io: "far√≤", tu: "farai", lui: "far√†", noi: "faremo", voi: "farete", loro: "faranno"
            },
            imperativo: {
              tu: "fa'/fai", lui: "faccia", noi: "facciamo", voi: "fate", loro: "facciano"
            },
            congiuntivo_presente: {
              io: "faccia", tu: "faccia", lui: "faccia", noi: "facciamo", voi: "facciate", loro: "facciano"
            },
            condizionale: {
              io: "farei", tu: "faresti", lui: "farebbe", noi: "faremmo", voi: "fareste", loro: "farebbero"
            }
          }
        },
        "dire": {
          translation: "to say",
          regular: false,
          difficulty: "intermediate",
          conjugations: {
            presente: {
              io: "dico", tu: "dici", lui: "dice", noi: "diciamo", voi: "dite", loro: "dicono"
            },
            passato_prossimo: {
              io: "ho detto", tu: "hai detto", lui: "ha detto", 
              noi: "abbiamo detto", voi: "avete detto", loro: "hanno detto"
            },
            futuro: {
              io: "dir√≤", tu: "dirai", lui: "dir√†", noi: "diremo", voi: "direte", loro: "diranno"
            },
            imperativo: {
              tu: "di'", lui: "dica", noi: "diciamo", voi: "dite", loro: "dicano"
            }
          }
        },
        "andare": {
          translation: "to go",
          regular: false,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "vado", tu: "vai", lui: "va", noi: "andiamo", voi: "andate", loro: "vanno"
            },
            passato_prossimo: {
              io: "sono andato/a", tu: "sei andato/a", lui: "√® andato/a", 
              noi: "siamo andati/e", voi: "siete andati/e", loro: "sono andati/e"
            },
            futuro: {
              io: "andr√≤", tu: "andrai", lui: "andr√†", noi: "andremo", voi: "andrete", loro: "andranno"
            },
            imperativo: {
              tu: "va'/vai", lui: "vada", noi: "andiamo", voi: "andate", loro: "vadano"
            }
          }
        },
        "stare": {
          translation: "to stay/be",
          regular: false,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "sto", tu: "stai", lui: "sta", noi: "stiamo", voi: "state", loro: "stanno"
            },
            passato_prossimo: {
              io: "sono stato/a", tu: "sei stato/a", lui: "√® stato/a", 
              noi: "siamo stati/e", voi: "siete stati/e", loro: "sono stati/e"
            },
            futuro: {
              io: "star√≤", tu: "starai", lui: "star√†", noi: "staremo", voi: "starete", loro: "staranno"
            },
            imperativo: {
              tu: "sta'/stai", lui: "stia", noi: "stiamo", voi: "state", loro: "stiano"
            }
          }
        },
        "dare": {
          translation: "to give",
          regular: false,
          difficulty: "intermediate",
          conjugations: {
            presente: {
              io: "do", tu: "dai", lui: "d√†", noi: "diamo", voi: "date", loro: "danno"
            },
            passato_prossimo: {
              io: "ho dato", tu: "hai dato", lui: "ha dato", 
              noi: "abbiamo dato", voi: "avete dato", loro: "hanno dato"
            },
            futuro: {
              io: "dar√≤", tu: "darai", lui: "dar√†", noi: "daremo", voi: "darete", loro: "daranno"
            },
            imperativo: {
              tu: "da'/dai", lui: "dia", noi: "diamo", voi: "date", loro: "diano"
            }
          }
        },
        "sapere": {
          translation: "to know",
          regular: false,
          difficulty: "intermediate",
          conjugations: {
            presente: {
              io: "so", tu: "sai", lui: "sa", noi: "sappiamo", voi: "sapete", loro: "sanno"
            },
            passato_prossimo: {
              io: "ho saputo", tu: "hai saputo", lui: "ha saputo", 
              noi: "abbiamo saputo", voi: "avete saputo", loro: "hanno saputo"
            },
            futuro: {
              io: "sapr√≤", tu: "saprai", lui: "sapr√†", noi: "sapremo", voi: "saprete", loro: "sapranno"
            },
            imperativo: {
              tu: "sappi", lui: "sappia", noi: "sappiamo", voi: "sappiate", loro: "sappiano"
            }
          }
        },
        "volere": {
          translation: "to want",
          regular: false,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "voglio", tu: "vuoi", lui: "vuole", noi: "vogliamo", voi: "volete", loro: "vogliono"
            },
            passato_prossimo: {
              io: "ho voluto", tu: "hai voluto", lui: "ha voluto", 
              noi: "abbiamo voluto", voi: "avete voluto", loro: "hanno voluto"
            },
            futuro: {
              io: "vorr√≤", tu: "vorrai", lui: "vorr√†", noi: "vorremo", voi: "vorrete", loro: "vorranno"
            },
            condizionale: {
              io: "vorrei", tu: "vorresti", lui: "vorrebbe", noi: "vorremmo", voi: "vorreste", loro: "vorrebbero"
            }
          }
        },
        "potere": {
          translation: "to be able",
          regular: false,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "posso", tu: "puoi", lui: "pu√≤", noi: "possiamo", voi: "potete", loro: "possono"
            },
            passato_prossimo: {
              io: "ho potuto", tu: "hai potuto", lui: "ha potuto", 
              noi: "abbiamo potuto", voi: "avete potuto", loro: "hanno potuto"
            },
            futuro: {
              io: "potr√≤", tu: "potrai", lui: "potr√†", noi: "potremo", voi: "potrete", loro: "potranno"
            },
            condizionale: {
              io: "potrei", tu: "potresti", lui: "potrebbe", noi: "potremmo", voi: "potreste", loro: "potrebbero"
            }
          }
        },
        "dovere": {
          translation: "to have to",
          regular: false,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "devo", tu: "devi", lui: "deve", noi: "dobbiamo", voi: "dovete", loro: "devono"
            },
            passato_prossimo: {
              io: "ho dovuto", tu: "hai dovuto", lui: "ha dovuto", 
              noi: "abbiamo dovuto", voi: "avete dovuto", loro: "hanno dovuto"
            },
            futuro: {
              io: "dovr√≤", tu: "dovrai", lui: "dovr√†", noi: "dovremo", voi: "dovrete", loro: "dovranno"
            },
            condizionale: {
              io: "dovrei", tu: "dovresti", lui: "dovrebbe", noi: "dovremmo", voi: "dovreste", loro: "dovrebbero"
            }
          }
        },
        "venire": {
          translation: "to come",
          regular: false,
          difficulty: "intermediate",
          conjugations: {
            presente: {
              io: "vengo", tu: "vieni", lui: "viene", noi: "veniamo", voi: "venite", loro: "vengono"
            },
            passato_prossimo: {
              io: "sono venuto/a", tu: "sei venuto/a", lui: "√® venuto/a", 
              noi: "siamo venuti/e", voi: "siete venuti/e", loro: "sono venuti/e"
            },
            futuro: {
              io: "verr√≤", tu: "verrai", lui: "verr√†", noi: "verremo", voi: "verrete", loro: "verranno"
            },
            imperativo: {
              tu: "vieni", lui: "venga", noi: "veniamo", voi: "venite", loro: "vengano"
            }
          }
        },
        "uscire": {
          translation: "to go out",
          regular: false,
          difficulty: "intermediate",
          conjugations: {
            presente: {
              io: "esco", tu: "esci", lui: "esce", noi: "usciamo", voi: "uscite", loro: "escono"
            },
            passato_prossimo: {
              io: "sono uscito/a", tu: "sei uscito/a", lui: "√® uscito/a", 
              noi: "siamo usciti/e", voi: "siete usciti/e", loro: "sono usciti/e"
            },
            futuro: {
              io: "uscir√≤", tu: "uscirai", lui: "uscir√†", noi: "usciremo", voi: "uscirete", loro: "usciranno"
            },
            imperativo: {
              tu: "esci", lui: "esca", noi: "usciamo", voi: "uscite", loro: "escano"
            }
          }
        },
        "parlare": {
          translation: "to speak",
          regular: true,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "parlo", tu: "parli", lui: "parla", noi: "parliamo", voi: "parlate", loro: "parlano"
            },
            passato_prossimo: {
              io: "ho parlato", tu: "hai parlato", lui: "ha parlato", 
              noi: "abbiamo parlato", voi: "avete parlato", loro: "hanno parlato"
            },
            futuro: {
              io: "parler√≤", tu: "parlerai", lui: "parler√†", noi: "parleremo", voi: "parlerete", loro: "parleranno"
            },
            imperativo: {
              tu: "parla", lui: "parli", noi: "parliamo", voi: "parlate", loro: "parlino"
            },
            congiuntivo_presente: {
              io: "parli", tu: "parli", lui: "parli", noi: "parliamo", voi: "parliate", loro: "parlino"
            },
            condizionale: {
              io: "parlerei", tu: "parleresti", lui: "parlerebbe", noi: "parleremmo", voi: "parlereste", loro: "parlerebbero"
            }
          }
        },
        "mangiare": {
          translation: "to eat",
          regular: true,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "mangio", tu: "mangi", lui: "mangia", noi: "mangiamo", voi: "mangiate", loro: "mangiano"
            },
            passato_prossimo: {
              io: "ho mangiato", tu: "hai mangiato", lui: "ha mangiato", 
              noi: "abbiamo mangiato", voi: "avete mangiato", loro: "hanno mangiato"
            },
            futuro: {
              io: "manger√≤", tu: "mangerai", lui: "manger√†", noi: "mangeremo", voi: "mangerete", loro: "mangeranno"
            },
            imperativo: {
              tu: "mangia", lui: "mangi", noi: "mangiamo", voi: "mangiate", loro: "mangino"
            }
          }
        },
        "dormire": {
          translation: "to sleep",
          regular: true,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "dormo", tu: "dormi", lui: "dorme", noi: "dormiamo", voi: "dormite", loro: "dormono"
            },
            passato_prossimo: {
              io: "ho dormito", tu: "hai dormito", lui: "ha dormito", 
              noi: "abbiamo dormito", voi: "avete dormito", loro: "hanno dormito"
            },
            futuro: {
              io: "dormir√≤", tu: "dormirai", lui: "dormir√†", noi: "dormiremo", voi: "dormirete", loro: "dormiranno"
            },
            imperativo: {
              tu: "dormi", lui: "dorma", noi: "dormiamo", voi: "dormite", loro: "dormano"
            }
          }
        },
        "lavorare": {
          translation: "to work",
          regular: true,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "lavoro", tu: "lavori", lui: "lavora", noi: "lavoriamo", voi: "lavorate", loro: "lavorano"
            },
            passato_prossimo: {
              io: "ho lavorato", tu: "hai lavorato", lui: "ha lavorato", 
              noi: "abbiamo lavorato", voi: "avete lavorato", loro: "hanno lavorato"
            },
            futuro: {
              io: "lavorer√≤", tu: "lavorerai", lui: "lavorer√†", noi: "lavoreremo", voi: "lavorerete", loro: "lavoreranno"
            },
            imperativo: {
              tu: "lavora", lui: "lavori", noi: "lavoriamo", voi: "lavorate", loro: "lavorino"
            }
          }
        },
        "studiare": {
          translation: "to study",
          regular: true,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "studio", tu: "studi", lui: "studia", noi: "studiamo", voi: "studiate", loro: "studiano"
            },
            passato_prossimo: {
              io: "ho studiato", tu: "hai studiato", lui: "ha studiato", 
              noi: "abbiamo studiato", voi: "avete studiato", loro: "hanno studiato"
            },
            futuro: {
              io: "studier√≤", tu: "studierai", lui: "studier√†", noi: "studieremo", voi: "studierete", loro: "studieranno"
            },
            imperativo: {
              tu: "studia", lui: "studi", noi: "studiamo", voi: "studiate", loro: "studino"
            }
          }
        },
        "abitare": {
          translation: "to live",
          regular: true,
          difficulty: "beginner",
          conjugations: {
            presente: {
              io: "abito", tu: "abiti", lui: "abita", noi: "abitiamo", voi: "abitate", loro: "abitano"
            },
            passato_prossimo: {
              io: "ho abitato", tu: "hai abitato", lui: "ha abitato", 
              noi: "abbiamo abitato", voi: "avete abitato", loro: "hanno abitato"
            },
            futuro: {
              io: "abiter√≤", tu: "abiterai", lui: "abiter√†", noi: "abiteremo", voi: "abiterete", loro: "abiteranno"
            },
            imperativo: {
              tu: "abita", lui: "abiti", noi: "abitiamo", voi: "abitate", loro: "abitino"
            }
          }
        },
        "sentire": {
          translation: "to feel/hear",
          regular: true,
          difficulty: "intermediate",
          conjugations: {
            presente: {
              io: "sento", tu: "senti", lui: "sente", noi: "sentiamo", voi: "sentite", loro: "sentono"
            },
            passato_prossimo: {
              io: "ho sentito", tu: "hai sentito", lui: "ha sentito", 
              noi: "abbiamo sentito", voi: "avete sentito", loro: "hanno sentito"
            },
            futuro: {
              io: "sentir√≤", tu: "sentirai", lui: "sentir√†", noi: "sentiremo", voi: "sentirete", loro: "sentiranno"
            },
            imperativo: {
              tu: "senti", lui: "senta", noi: "sentiamo", voi: "sentite", loro: "sentano"
            }
          }
        }
      };

      // Conjugation type definitions
      const conjugationTypes = {
        basic: ['presente', 'passato_prossimo', 'futuro', 'imperativo'],
        advanced: ['presente', 'passato_prossimo', 'futuro', 'imperativo', 'congiuntivo_presente', 'condizionale']
      };

      // Person definitions in Italian
      const persons = {
        io: "prima persona singolare",
        tu: "seconda persona singolare", 
        lui: "terza persona singolare",
        noi: "prima persona plurale",
        voi: "seconda persona plurale",
        loro: "terza persona plurale"
      };

      // Tense names in Italian
      const tenseNames = {
        presente: "presente",
        passato_prossimo: "passato prossimo",
        futuro: "futuro",
        imperativo: "imperativo",
        congiuntivo_presente: "congiuntivo presente",
        condizionale: "condizionale"
      };

      // Current practice state
      let currentVerb = null;
      let currentTense = null;
      let currentPerson = null;
      let currentAnswer = null;
      let attempts = 0;
      let maxAttempts = 3;

      // Statistics
      let stats = {
        correct: 0,
        total: 0,
        currentStreak: 0,
        bestStreak: 0,
        recentMistakes: []
      };

      // Settings
      let settings = {
        verbLevel: 'advanced',
        conjugationLevel: 'basic',
        showRegularityHint: true,
        allowMultipleAttempts: true
      };

      // Function to pronounce Italian words using ResponsiveVoice
      function pronounceWord(word) {
        if (typeof responsiveVoice !== "undefined") {
          responsiveVoice.speak(word, "Italian Male", {
            rate: 0.95,
            pitch: 1,
            volume: 1,
          });
        } else {
          console.log("ResponsiveVoice not loaded yet");
          alert("Pronunciation feature is still loading. Please try again in a moment.");
        }
      }

      // Open Italian conjugation in new tab
      function openConjugation(verb) {
        const conjugationUrl = `https://conjugator.reverso.net/conjugation-italian-verb-${encodeURIComponent(verb)}.html`;
        window.open(conjugationUrl, "_blank");
      }

      // Normalize text for comparison (remove accents, case insensitive)
      function normalizeText(text) {
        return text
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "") // Remove accent marks
          .replace(/['']/g, "'") // Normalize apostrophes
          .trim();
      }

      // Get available verbs based on current difficulty setting
      function getAvailableVerbs() {
        const targetDifficulties = [];
        
        if (settings.verbLevel === 'beginner') {
          targetDifficulties.push('beginner');
        } else if (settings.verbLevel === 'intermediate') {
          targetDifficulties.push('beginner', 'intermediate');
        } else {
          targetDifficulties.push('beginner', 'intermediate', 'advanced');
        }

        return Object.keys(verbDatabase).filter(verb => 
          targetDifficulties.includes(verbDatabase[verb].difficulty)
        );
      }

      // Get available tenses based on conjugation level setting
      function getAvailableTenses(verb) {
        const verbData = verbDatabase[verb];
        const availableForLevel = conjugationTypes[settings.conjugationLevel];
        
        return availableForLevel.filter(tense => 
          verbData.conjugations[tense] !== undefined
        );
      }

      // Get new random verb conjugation challenge
      function getNewVerb() {
        const availableVerbs = getAvailableVerbs();
        
        if (availableVerbs.length === 0) {
          showFeedback('No verbs available for current settings', 'error');
          return;
        }

        // Select random verb
        currentVerb = availableVerbs[Math.floor(Math.random() * availableVerbs.length)];
        
        // Get available tenses for this verb
        const availableTenses = getAvailableTenses(currentVerb);
        
        if (availableTenses.length === 0) {
          showFeedback('No tenses available for this verb', 'error');
          return;
        }

        // Select random tense
        currentTense = availableTenses[Math.floor(Math.random() * availableTenses.length)];
        
        // Select random person
        const availablePersons = Object.keys(verbDatabase[currentVerb].conjugations[currentTense]);
        currentPerson = availablePersons[Math.floor(Math.random() * availablePersons.length)];
        
        // Get correct answer
        currentAnswer = verbDatabase[currentVerb].conjugations[currentTense][currentPerson];
        
        // Reset attempts
        attempts = 0;
        
        // Display the challenge
        displayChallenge();
        
        // Clear previous feedback
        hideFeedback();
        
        console.log(`New challenge: ${currentVerb} - ${currentTense} - ${currentPerson} = ${currentAnswer}`);
      }

      // Display the current challenge
      function displayChallenge() {
        const display = document.getElementById('conjugationDisplay');
        const verbData = verbDatabase[currentVerb];
        
        const regularityHint = settings.showRegularityHint ? 
          `<div style="font-size: 0.9em; color: #6c757d; margin-bottom: 15px;">
            ${verbData.regular ? '‚úì Regular verb' : '‚ö†Ô∏è Irregular verb'}
          </div>` : '';

        display.innerHTML = `
          <div class="verb-prompt">
            ${currentVerb}
            <span class="speaker-icon" onclick="pronounceWord('${currentVerb}')" title="Pronounce verb">üîä</span>
            <span class="dict-icon" onclick="openConjugation('${currentVerb}')" title="View full conjugation">üìñ</span>
          </div>
          <div style="font-size: 1.1em; color: #6c757d; margin-bottom: 15px;">
            ${verbData.translation}
          </div>
          ${regularityHint}
          <div class="conjugation-prompt">
            ${tenseNames[currentTense]} - ${persons[currentPerson]}
          </div>
          <div class="answer-section">
            <input type="text" class="answer-input" id="answerInput" 
                   placeholder="Type your answer..." onkeypress="handleKeyPress(event)">
          </div>
          <div class="controls" style="margin-top: 15px;">
            <button class="btn" onclick="checkAnswer()">Check Answer</button>
            <button class="btn btn-warning" onclick="showCorrectAnswer()">Show Answer</button>
          </div>
        `;
        
        // Focus on input
        document.getElementById('answerInput').focus();
      }

      // Handle Enter key press
      function handleKeyPress(event) {
        if (event.key === 'Enter') {
          checkAnswer();
        }
      }

      // Check the user's answer
      function checkAnswer() {
        const userAnswer = document.getElementById('answerInput').value.trim();
        
        if (!userAnswer) {
          showFeedback('Please enter an answer', 'error');
          return;
        }

        attempts++;
        
        // Normalize both answers for comparison
        const normalizedUser = normalizeText(userAnswer);
        const normalizedCorrect = normalizeText(currentAnswer);
        
        if (normalizedUser === normalizedCorrect) {
          // Correct answer
          handleCorrectAnswer();
        } else {
          // Wrong answer
          handleWrongAnswer(userAnswer);
        }
      }

      // Handle correct answer
      function handleCorrectAnswer() {
        const input = document.getElementById('answerInput');
        input.className = 'answer-input correct';
        input.disabled = true;
        
        // Update stats
        stats.correct++;
        stats.total++;
        stats.currentStreak++;
        
        if (stats.currentStreak > stats.bestStreak) {
          stats.bestStreak = stats.currentStreak;
        }
        
        updateStatsDisplay();
        
        showFeedback(`Correct! üéâ`, 'success');
        
        // Auto-advance after 2 seconds
        setTimeout(() => {
          getNewVerb();
        }, 2000);
      }

      // Handle wrong answer
      function handleWrongAnswer(userAnswer) {
        const input = document.getElementById('answerInput');
        input.className = 'answer-input incorrect';
        
        stats.total++;
        stats.currentStreak = 0;
        
        // Add to recent mistakes
        stats.recentMistakes.unshift({
          verb: currentVerb,
          tense: currentTense,
          person: currentPerson,
          userAnswer: userAnswer,
          correctAnswer: currentAnswer,
          timestamp: new Date()
        });
        
        // Keep only last 10 mistakes
        if (stats.recentMistakes.length > 10) {
          stats.recentMistakes = stats.recentMistakes.slice(0, 10);
        }
        
        updateStatsDisplay();
        updateRecentMistakes();
        
        if (settings.allowMultipleAttempts && attempts < maxAttempts) {
          showFeedback(`Not quite right. Try again! (Attempt ${attempts}/${maxAttempts})`, 'error');
          
          // Reset input style after a moment and let them try again
          setTimeout(() => {
            input.className = 'answer-input';
            input.value = '';
            input.focus();
          }, 1500);
        } else {
          showFeedback(`Incorrect. The answer is: <strong>${currentAnswer}</strong>`, 'error');
          input.disabled = true;
          
          // Auto-advance after 3 seconds
          setTimeout(() => {
            getNewVerb();
          }, 3000);
        }
      }

      // Show correct answer
      function showCorrectAnswer() {
        const input = document.getElementById('answerInput');
        input.value = currentAnswer;
        input.className = 'answer-input';
        input.disabled = true;
        
        showFeedback(`The correct answer is: <strong>${currentAnswer}</strong>`, 'info');
        
        // This counts as getting it wrong for stats
        stats.total++;
        stats.currentStreak = 0;
        updateStatsDisplay();
        
        // Auto-advance after 3 seconds
        setTimeout(() => {
          getNewVerb();
        }, 3000);
      }

      // Show feedback message
      function showFeedback(message, type) {
        const feedback = document.querySelector('.feedback-section');
        if (!feedback) {
          // Create feedback section if it doesn't exist
          const feedbackDiv = document.createElement('div');
          feedbackDiv.className = 'feedback-section';
          document.getElementById('conjugationDisplay').appendChild(feedbackDiv);
        }
        
        const feedbackElement = document.querySelector('.feedback-section');
        feedbackElement.innerHTML = message;
        feedbackElement.className = `feedback-section ${type}`;
      }

      // Hide feedback
      function hideFeedback() {
        const feedback = document.querySelector('.feedback-section');
        if (feedback) {
          feedback.className = 'feedback-section';
        }
      }

      // Update statistics display
      function updateStatsDisplay() {
        document.getElementById('correctCount').textContent = stats.correct;
        document.getElementById('totalCount').textContent = stats.total;
        
        const accuracy = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
        document.getElementById('accuracyPercent').textContent = accuracy + '%';
        
        document.getElementById('sessionLength').textContent = stats.total;
        document.getElementById('currentStreak').textContent = stats.currentStreak;
        document.getElementById('bestStreak').textContent = stats.bestStreak;
      }

      // Update recent mistakes display
      function updateRecentMistakes() {
        const container = document.getElementById('recentMistakes');
        
        if (stats.recentMistakes.length === 0) {
          container.innerHTML = '<p style="color: #6c757d; font-style: italic; text-align: center;">No mistakes yet - great job!</p>';
          return;
        }
        
        const mistakesHtml = stats.recentMistakes.map(mistake => `
          <div style="background: #f8f9fa; padding: 10px; margin-bottom: 8px; border-radius: 5px; border-left: 3px solid #dc3545;">
            <strong>${mistake.verb}</strong> (${tenseNames[mistake.tense]} - ${persons[mistake.person]})<br>
            <span style="color: #dc3545;">Your answer: ${mistake.userAnswer}</span><br>
            <span style="color: #28a745;">Correct: ${mistake.correctAnswer}</span>
          </div>
        `).join('');
        
        container.innerHTML = mistakesHtml;
      }

      // Reset statistics
      function resetStats() {
        stats = {
          correct: 0,
          total: 0,
          currentStreak: 0,
          bestStreak: 0,
          recentMistakes: []
        };
        
        updateStatsDisplay();
        updateRecentMistakes();
        
        showFeedback('Statistics reset!', 'info');
        setTimeout(hideFeedback, 2000);
      }

      // Update settings
      function updateSettings() {
        settings.verbLevel = document.getElementById('verbLevel').value;
        settings.conjugationLevel = document.getElementById('conjugationLevel').value;
        settings.showRegularityHint = document.getElementById('showRegularityHint').checked;
        settings.allowMultipleAttempts = document.getElementById('allowMultipleAttempts').checked;
        
        // Update verb count display
        const availableVerbs = getAvailableVerbs();
        document.getElementById('verbCountDisplay').textContent = availableVerbs.length;
        
        console.log('Settings updated:', settings);
      }

      // Tab switching functionality
      function setupTabSwitching() {
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
          });
        });
      }

      // Initialize the app
      function initializeApp() {
        setupTabSwitching();
        updateSettings();
        updateStatsDisplay();
        updateRecentMistakes();
        
        console.log('Italian Conjugation Practice app initialized');
        console.log('Available verbs:', Object.keys(verbDatabase).length);
      }

      // Wait for DOM to be ready before initializing
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
      } else {
        initializeApp();
      }

      // Register service worker for PWA functionality
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4gewogIGV2ZW50LndhaXRVbnRpbChzZWxmLnNraXBXYWl0aW5nKCkpOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignYWN0aXZhdGUnLCBldmVudCA9PiB7CiAgZXZlbnQud2FpdFVudGlsKHNlbGYuY2xpZW50cy5jbGFpbSgpKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZXZlbnQgPT4gewogIGV2ZW50LnJlc3BvbmRXaXRoKGZldGNoKGV2ZW50LnJlcXVlc3QpKTsKfSk7')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed'));
      }
    </script>
  </body>
</html>
